import{a as B,b as F}from"./chunk-EGYWD4KQ.js";import{a as ue}from"./chunk-EMBPV7JI.js";import{d as D,e as $,f as ie,i as oe,j as v,o as ae,q as C,t as W,u as le,w as pe}from"./chunk-FEUSPEM3.js";import{A as g,B as H,E as ce,G as he,H as de,I as fe,J as me,N as _e,a as p,b as E,h as L,m as S,p as R,q as V,w as P,y as ne}from"./chunk-AOUDBIVJ.js";import{a as b,b as G}from"./chunk-C6Q5SG76.js";var Y=(r=>(r[r.Low=0]="Low",r[r.Normal=1]="Normal",r[r.High=2]="High",r))(Y||{});function y(r){if(typeof r!="string")throw new TypeError(`Path must be a string. Received ${JSON.stringify(r)}`)}function w(r){return r.split("?")[0].split("#")[0]}function Ce(r){return r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function we(r,e,t){return r.replace(new RegExp(Ce(e),"g"),t)}function Ie(r,e){let t="",s=0,i=-1,o=0,a=-1;for(let n=0;n<=r.length;++n){if(n<r.length)a=r.charCodeAt(n);else{if(a===47)break;a=47}if(a===47){if(!(i===n-1||o===1))if(i!==n-1&&o===2){if(t.length<2||s!==2||t.charCodeAt(t.length-1)!==46||t.charCodeAt(t.length-2)!==46){if(t.length>2){let l=t.lastIndexOf("/");if(l!==t.length-1){l===-1?(t="",s=0):(t=t.slice(0,l),s=t.length-1-t.lastIndexOf("/")),i=n,o=0;continue}}else if(t.length===2||t.length===1){t="",s=0,i=n,o=0;continue}}e&&(t.length>0?t+="/..":t="..",s=2)}else t.length>0?t+=`/${r.slice(i+1,n)}`:t=r.slice(i+1,n),s=n-i-1;i=n,o=0}else a===46&&o!==-1?++o:o=-1}return t}var k={toPosix(r){return we(r,"\\","/")},isUrl(r){return/^https?:/.test(this.toPosix(r))},isDataUrl(r){return/^data:([a-z]+\/[a-z0-9-+.]+(;[a-z0-9-.!#$%*+.{}|~`]+=[a-z0-9-.!#$%*+.{}()_|~`]+)*)?(;base64)?,([a-z0-9!$&',()*+;=\-._~:@\/?%\s<>]*?)$/i.test(r)},isBlobUrl(r){return r.startsWith("blob:")},hasProtocol(r){return/^[^/:]+:/.test(this.toPosix(r))},getProtocol(r){y(r),r=this.toPosix(r);let e=/^file:\/\/\//.exec(r);if(e)return e[0];let t=/^[^/:]+:\/{0,2}/.exec(r);return t?t[0]:""},toAbsolute(r,e,t){if(y(r),this.isDataUrl(r)||this.isBlobUrl(r))return r;let s=w(this.toPosix(e??H.get().getBaseUrl())),i=w(this.toPosix(t??this.rootname(s)));return r=this.toPosix(r),r.startsWith("/")?k.join(i,r.slice(1)):this.isAbsolute(r)?r:this.join(s,r)},normalize(r){if(y(r),r.length===0)return".";if(this.isDataUrl(r)||this.isBlobUrl(r))return r;r=this.toPosix(r);let e="",t=r.startsWith("/");this.hasProtocol(r)&&(e=this.rootname(r),r=r.slice(e.length));let s=r.endsWith("/");return r=Ie(r,!1),r.length>0&&s&&(r+="/"),t?`/${r}`:e+r},isAbsolute(r){return y(r),r=this.toPosix(r),this.hasProtocol(r)?!0:r.startsWith("/")},join(...r){if(r.length===0)return".";let e;for(let t=0;t<r.length;++t){let s=r[t];if(y(s),s.length>0)if(e===void 0)e=s;else{let i=r[t-1]??"";this.joinExtensions.includes(this.extname(i).toLowerCase())?e+=`/../${s}`:e+=`/${s}`}}return e===void 0?".":this.normalize(e)},dirname(r){if(y(r),r.length===0)return".";r=this.toPosix(r);let e=r.charCodeAt(0),t=e===47,s=-1,i=!0,o=this.getProtocol(r),a=r;r=r.slice(o.length);for(let n=r.length-1;n>=1;--n)if(e=r.charCodeAt(n),e===47){if(!i){s=n;break}}else i=!1;return s===-1?t?"/":this.isUrl(a)?o+r:o:t&&s===1?"//":o+r.slice(0,s)},rootname(r){y(r),r=this.toPosix(r);let e="";if(r.startsWith("/")?e="/":e=this.getProtocol(r),this.isUrl(r)){let t=r.indexOf("/",e.length);t!==-1?e=r.slice(0,t):e=r,e.endsWith("/")||(e+="/")}return e},basename(r,e){y(r),e&&y(e),r=w(this.toPosix(r));let t=0,s=-1,i=!0,o;if(e!==void 0&&e.length>0&&e.length<=r.length){if(e.length===r.length&&e===r)return"";let a=e.length-1,n=-1;for(o=r.length-1;o>=0;--o){let l=r.charCodeAt(o);if(l===47){if(!i){t=o+1;break}}else n===-1&&(i=!1,n=o+1),a>=0&&(l===e.charCodeAt(a)?--a===-1&&(s=o):(a=-1,s=n))}return t===s?s=n:s===-1&&(s=r.length),r.slice(t,s)}for(o=r.length-1;o>=0;--o)if(r.charCodeAt(o)===47){if(!i){t=o+1;break}}else s===-1&&(i=!1,s=o+1);return s===-1?"":r.slice(t,s)},extname(r){y(r),r=w(this.toPosix(r));let e=-1,t=0,s=-1,i=!0,o=0;for(let a=r.length-1;a>=0;--a){let n=r.charCodeAt(a);if(n===47){if(!i){t=a+1;break}continue}s===-1&&(i=!1,s=a+1),n===46?e===-1?e=a:o!==1&&(o=1):e!==-1&&(o=-1)}return e===-1||s===-1||o===0||o===1&&e===s-1&&e===t+1?"":r.slice(e,s)},parse(r){y(r);let e={root:"",dir:"",base:"",ext:"",name:""};if(r.length===0)return e;r=w(this.toPosix(r));let t=r.charCodeAt(0),s=this.isAbsolute(r),i,o="";e.root=this.rootname(r),s||this.hasProtocol(r)?i=1:i=0;let a=-1,n=0,l=-1,u=!0,h=r.length-1,c=0;for(;h>=i;--h){if(t=r.charCodeAt(h),t===47){if(!u){n=h+1;break}continue}l===-1&&(u=!1,l=h+1),t===46?a===-1?a=h:c!==1&&(c=1):a!==-1&&(c=-1)}return a===-1||l===-1||c===0||c===1&&a===l-1&&a===n+1?l!==-1&&(n===0&&s?e.base=e.name=r.slice(1,l):e.base=e.name=r.slice(n,l)):(n===0&&s?(e.name=r.slice(1,a),e.base=r.slice(1,l)):(e.name=r.slice(n,a),e.base=r.slice(n,l)),e.ext=r.slice(a,l)),e.dir=this.dirname(r),o&&(e.dir=o+e.dir),e},sep:"/",delimiter:":",joinExtensions:[".html"]};function Ae(r,e,t,s,i){let o=e[t];for(let a=0;a<o.length;a++){let n=o[a];t<e.length-1?Ae(r.replace(s[t],n),e,t+1,s,i):i.push(r.replace(s[t],n))}}function xe(r){let e=/\{(.*?)\}/g,t=r.match(e),s=[];if(t){let i=[];t.forEach(o=>{let a=o.substring(1,o.length-1).split(",");i.push(a)}),Ae(r,i,0,t,s)}else s.push(r);return s}var X=r=>!Array.isArray(r);var ge=(()=>{class r{constructor(){this._defaultBundleIdentifierOptions={connector:"-",createBundleAssetId:(t,s)=>`${t}${this._bundleIdConnector}${s}`,extractAssetIdFromBundle:(t,s)=>s.replace(`${t}${this._bundleIdConnector}`,"")},this._bundleIdConnector=this._defaultBundleIdentifierOptions.connector,this._createBundleAssetId=this._defaultBundleIdentifierOptions.createBundleAssetId,this._extractAssetIdFromBundle=this._defaultBundleIdentifierOptions.extractAssetIdFromBundle,this._assetMap={},this._preferredOrder=[],this._parsers=[],this._resolverHash={},this._bundles={}}setBundleIdentifier(t){if(this._bundleIdConnector=t.connector??this._bundleIdConnector,this._createBundleAssetId=t.createBundleAssetId??this._createBundleAssetId,this._extractAssetIdFromBundle=t.extractAssetIdFromBundle??this._extractAssetIdFromBundle,this._extractAssetIdFromBundle("foo",this._createBundleAssetId("foo","bar"))!=="bar")throw new Error("[Resolver] GenerateBundleAssetId are not working correctly")}prefer(...t){t.forEach(s=>{this._preferredOrder.push(s),s.priority||(s.priority=Object.keys(s.params))}),this._resolverHash={}}set basePath(t){this._basePath=t}get basePath(){return this._basePath}set rootPath(t){this._rootPath=t}get rootPath(){return this._rootPath}get parsers(){return this._parsers}reset(){this.setBundleIdentifier(this._defaultBundleIdentifierOptions),this._assetMap={},this._preferredOrder=[],this._resolverHash={},this._rootPath=null,this._basePath=null,this._manifest=null,this._bundles={},this._defaultSearchParams=null}setDefaultSearchParams(t){if(typeof t=="string")this._defaultSearchParams=t;else{let s=t;this._defaultSearchParams=Object.keys(s).map(i=>`${encodeURIComponent(i)}=${encodeURIComponent(s[i])}`).join("&")}}getAlias(t){let{alias:s,src:i}=t;return B(s||i,a=>typeof a=="string"?a:Array.isArray(a)?a.map(n=>n?.src??n):a?.src?a.src:a,!0)}addManifest(t){this._manifest&&S("[Resolver] Manifest already exists, this will be overwritten"),this._manifest=t,t.bundles.forEach(s=>{this.addBundle(s.name,s.assets)})}addBundle(t,s){let i=[],o=s;Array.isArray(s)||(o=Object.entries(s).map(([a,n])=>typeof n=="string"||Array.isArray(n)?{alias:a,src:n}:b({alias:a},n))),o.forEach(a=>{let n=a.src,l=a.alias,u;if(typeof l=="string"){let h=this._createBundleAssetId(t,l);i.push(h),u=[l,h]}else{let h=l.map(c=>this._createBundleAssetId(t,c));i.push(...h),u=[...l,...h]}this.add(G(b({},a),{alias:u,src:n}))}),this._bundles[t]=i}add(t){let s=[];Array.isArray(t)?s.push(...t):s.push(t);let i;i=a=>{this.hasKey(a)&&S(`[Resolver] already has key: ${a} overwriting`)},B(s).forEach(a=>{let{src:n}=a,{data:l,format:u,loadParser:h,parser:c}=a,d=B(n).map(A=>typeof A=="string"?xe(A):Array.isArray(A)?A:[A]),f=this.getAlias(a);Array.isArray(f)?f.forEach(i):i(f);let _=[],T=A=>{let m=this._parsers.find(x=>x.test(A));return b({src:A},m?.parse(A))};d.forEach(A=>{A.forEach(m=>{let x={};if(typeof m!="object"?x=T(m):(l=m.data??l,u=m.format??u,(m.loadParser||m.parser)&&(h=m.loadParser??h,c=m.parser??c),x=b(b({},T(m.src)),m)),!f)throw new Error(`[Resolver] alias is undefined for this asset: ${x.src}`);x=this._buildResolvedAsset(x,{aliases:f,data:l,format:u,loadParser:h,parser:c,progressSize:a.progressSize}),_.push(x)})}),f.forEach(A=>{this._assetMap[A]=_})})}resolveBundle(t){let s=X(t);t=B(t);let i={};return t.forEach(o=>{let a=this._bundles[o];if(a){let n=this.resolve(a),l={};for(let u in n){let h=n[u];l[this._extractAssetIdFromBundle(o,u)]=h}i[o]=l}}),s?i[t[0]]:i}resolveUrl(t){let s=this.resolve(t);if(typeof t!="string"){let i={};for(let o in s)i[o]=s[o].src;return i}return s.src}resolve(t){let s=X(t);t=B(t);let i={};return t.forEach(o=>{if(!this._resolverHash[o])if(this._assetMap[o]){let a=this._assetMap[o],n=this._getPreferredOrder(a);n?.priority.forEach(l=>{n.params[l].forEach(u=>{let h=a.filter(c=>c[l]?c[l]===u:!1);h.length&&(a=h)})}),this._resolverHash[o]=a[0]}else this._resolverHash[o]=this._buildResolvedAsset({alias:[o],src:o},{});i[o]=this._resolverHash[o]}),s?i[t[0]]:i}hasKey(t){return!!this._assetMap[t]}hasBundle(t){return!!this._bundles[t]}_getPreferredOrder(t){for(let s=0;s<t.length;s++){let i=t[s],o=this._preferredOrder.find(a=>a.params.format.includes(i.format));if(o)return o}return this._preferredOrder[0]}_appendDefaultSearchParams(t){if(!this._defaultSearchParams)return t;let s=/\?/.test(t)?"&":"?";return`${t}${s}${this._defaultSearchParams}`}_buildResolvedAsset(t,s){let{aliases:i,data:o,loadParser:a,parser:n,format:l,progressSize:u}=s;return(this._basePath||this._rootPath)&&(t.src=k.toAbsolute(t.src,this._basePath,this._rootPath)),t.alias=i??t.alias??[t.src],t.src=this._appendDefaultSearchParams(t.src),t.data=b(b({},o||{}),t.data),t.loadParser=a??t.loadParser,t.parser=n??t.parser,t.format=l??t.format??Me(t.src),u!==void 0&&(t.progressSize=u),t}}return r.RETINA_PREFIX=/@([0-9\.]+)x/,r})();function Me(r){return r.split(".").pop().split("?").shift().split("#").shift()}var Q=(r,e)=>{let t=e.split("?")[1];return t&&(r+=`?${t}`),r};var Ue=(()=>{let r=class I{constructor(t,s){this.linkedSheets=[];let i=t;t?.source instanceof P&&(i={texture:t,data:s});let{texture:o,data:a,cachePrefix:n=""}=i;this.cachePrefix=n,this._texture=o instanceof g?o:null,this.textureSource=o.source,this.textures={},this.animations={},this.data=a;let l=parseFloat(a.meta.scale);l?(this.resolution=l,o.source.resolution=this.resolution):this.resolution=o.source._resolution,this._frames=this.data.frames,this._frameKeys=Object.keys(this._frames),this._batchIndex=0,this._callback=null}parse(){return new Promise(t=>{this._callback=t,this._batchIndex=0,this._frameKeys.length<=I.BATCH_SIZE?(this._processFrames(0),this._processAnimations(),this._parseComplete()):this._nextBatch()})}parseSync(){return this._processFrames(0,!0),this._processAnimations(),this.textures}_processFrames(t,s=!1){let i=t,o=s?1/0:I.BATCH_SIZE;for(;i-t<o&&i<this._frameKeys.length;){let a=this._frameKeys[i],n=this._frames[a],l=n.frame;if(l){let u=null,h=null,c=n.trimmed!==!1&&n.sourceSize?n.sourceSize:n.frame,d=new R(0,0,Math.floor(c.w)/this.resolution,Math.floor(c.h)/this.resolution);n.rotated?u=new R(Math.floor(l.x)/this.resolution,Math.floor(l.y)/this.resolution,Math.floor(l.h)/this.resolution,Math.floor(l.w)/this.resolution):u=new R(Math.floor(l.x)/this.resolution,Math.floor(l.y)/this.resolution,Math.floor(l.w)/this.resolution,Math.floor(l.h)/this.resolution),n.trimmed!==!1&&n.spriteSourceSize&&(h=new R(Math.floor(n.spriteSourceSize.x)/this.resolution,Math.floor(n.spriteSourceSize.y)/this.resolution,Math.floor(l.w)/this.resolution,Math.floor(l.h)/this.resolution)),this.textures[a]=new g({source:this.textureSource,frame:u,orig:d,trim:h,rotate:n.rotated?2:0,defaultAnchor:n.anchor,defaultBorders:n.borders,label:a.toString()})}i++}}_processAnimations(){let t=this.data.animations||{};for(let s in t){this.animations[s]=[];for(let i=0;i<t[s].length;i++){let o=t[s][i];this.animations[s].push(this.textures[o])}}}_parseComplete(){let t=this._callback;this._callback=null,this._batchIndex=0,t.call(this,this.textures)}_nextBatch(){this._processFrames(this._batchIndex*I.BATCH_SIZE),this._batchIndex++,setTimeout(()=>{this._batchIndex*I.BATCH_SIZE<this._frameKeys.length?this._nextBatch():(this._processAnimations(),this._parseComplete())},0)}destroy(t=!1){for(let s in this.textures)this.textures[s].destroy();this._frames=null,this._frameKeys=null,this.data=null,this.textures=null,t&&(this._texture?.destroy(),this.textureSource.destroy()),this._texture=null,this.textureSource=null,this.linkedSheets=[]}};return r.BATCH_SIZE=1e3,r})(),Z=Ue;var Oe=["jpg","png","jpeg","avif","webp","basis","etc2","bc7","bc6h","bc5","bc4","bc3","bc2","bc1","eac","astc"];function Te(r,e,t){let s={};if(r.forEach(i=>{s[i]=e}),Object.keys(e.textures).forEach(i=>{s[`${e.cachePrefix}${i}`]=e.textures[i]}),!t){let i=k.dirname(r[0]);e.linkedSheets.forEach((o,a)=>{let n=Te([`${i}/${e.data.meta.related_multi_packs[a]}`],o,!0);Object.assign(s,n)})}return s}var be={extension:p.Asset,cache:{test:r=>r instanceof Z,getCacheableAssets:(r,e)=>Te(r,e,!1)},resolver:{extension:{type:p.ResolveParser,name:"resolveSpritesheet"},test:r=>{let t=r.split("?")[0].split("."),s=t.pop(),i=t.pop();return s==="json"&&Oe.includes(i)},parse:r=>{let e=r.split(".");return{resolution:parseFloat(ge.RETINA_PREFIX.exec(r)?.[1]??"1"),format:e[e.length-2],src:r}}},loader:{name:"spritesheetLoader",id:"spritesheet",extension:{type:p.LoadParser,priority:Y.Normal,name:"spritesheetLoader"},async testParse(r,e){return k.extname(e.src).toLowerCase()===".json"&&!!r.frames},async parse(r,e,t){let{texture:s,imageFilename:i,textureOptions:o,cachePrefix:a}=e?.data??{},n=k.dirname(e.src);n&&n.lastIndexOf("/")!==n.length-1&&(n+="/");let l;if(s instanceof g)l=s;else{let c=Q(n+(i??r.meta.image),e.src);l=(await t.load([{src:c,data:o}]))[c]}let u=new Z({texture:l.source,data:r,cachePrefix:a});await u.parse();let h=r?.meta?.related_multi_packs;if(Array.isArray(h)){let c=[];for(let f of h){if(typeof f!="string")continue;let _=n+f;e.data?.ignoreMultiPack||(_=Q(_,e.src),c.push(t.load({src:_,data:{textureOptions:o,ignoreMultiPack:!0}})))}let d=await Promise.all(c);u.linkedSheets=d,d.forEach(f=>{f.linkedSheets=[u].concat(u.linkedSheets.filter(_=>_!==f))})}return u},async unload(r,e,t){await t.unload(r.textureSource._sourceOrigin),r.destroy(!1)}}};E.add(be);var Ge=new V;function z(r,e,t){let s=Ge;r.measurable=!0,ie(r,t,s),e.addBoundsMask(s),r.measurable=!1}function N(r,e,t){let s=$.get();r.measurable=!0;let i=D.get().identity(),o=ye(r,t,i);oe(r,s,o),r.measurable=!1,e.addBoundsMask(s),D.return(i),$.return(s)}function ye(r,e,t){return r?(r!==e&&(ye(r.parent,e,t),r.updateLocalTransform(),t.append(r.localTransform)),t):(S("Mask bounds, renderable is not inside the root container"),t)}var M=class{constructor(e){this.priority=0,this.inverse=!1,this.pipe="alphaMask",e?.mask&&this.init(e.mask)}init(e){this.mask=e,this.renderMaskToTexture=!(e instanceof W),this.mask.renderable=this.renderMaskToTexture,this.mask.includeInBuild=!this.renderMaskToTexture,this.mask.measurable=!1}reset(){this.mask!==null&&(this.mask.measurable=!0,this.mask=null)}addBounds(e,t){this.inverse||z(this.mask,e,t)}addLocalBounds(e,t){N(this.mask,e,t)}containsPoint(e,t){let s=this.mask;return t(s,e)}destroy(){this.reset()}static test(e){return e instanceof W}};M.extension=p.MaskEffect;var U=class{constructor(e){this.priority=0,this.pipe="colorMask",e?.mask&&this.init(e.mask)}init(e){this.mask=e}destroy(){}static test(e){return typeof e=="number"}};U.extension=p.MaskEffect;var O=class{constructor(e){this.priority=0,this.pipe="stencilMask",e?.mask&&this.init(e.mask)}init(e){this.mask=e,this.mask.includeInBuild=!1,this.mask.measurable=!1}reset(){this.mask!==null&&(this.mask.measurable=!0,this.mask.includeInBuild=!0,this.mask=null)}addBounds(e,t){z(this.mask,e,t)}addLocalBounds(e,t){N(this.mask,e,t)}containsPoint(e,t){let s=this.mask;return t(s,e)}destroy(){this.reset()}static test(e){return e instanceof ae}};O.extension=p.MaskEffect;var K;async function Pe(){return K??(K=(async()=>{let e=H.get().createCanvas(1,1).getContext("webgl");if(!e)return"premultiply-alpha-on-upload";let t=await new Promise(a=>{let n=document.createElement("video");n.onloadeddata=()=>a(n),n.onerror=()=>a(null),n.autoplay=!1,n.crossOrigin="anonymous",n.preload="auto",n.src="data:video/webm;base64,GkXfo59ChoEBQveBAULygQRC84EIQoKEd2VibUKHgQJChYECGFOAZwEAAAAAAAHTEU2bdLpNu4tTq4QVSalmU6yBoU27i1OrhBZUrmtTrIHGTbuMU6uEElTDZ1OsggEXTbuMU6uEHFO7a1OsggG97AEAAAAAAABZAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAVSalmoCrXsYMPQkBNgIRMYXZmV0GETGF2ZkSJiEBEAAAAAAAAFlSua8yuAQAAAAAAAEPXgQFzxYgAAAAAAAAAAZyBACK1nIN1bmSIgQCGhVZfVlA5g4EBI+ODhAJiWgDglLCBArqBApqBAlPAgQFVsIRVuYEBElTDZ9Vzc9JjwItjxYgAAAAAAAAAAWfInEWjh0VOQ09ERVJEh49MYXZjIGxpYnZweC12cDlnyKJFo4hEVVJBVElPTkSHlDAwOjAwOjAwLjA0MDAwMDAwMAAAH0O2dcfngQCgwqGggQAAAIJJg0IAABAAFgA4JBwYSgAAICAAEb///4r+AAB1oZ2mm+6BAaWWgkmDQgAAEAAWADgkHBhKAAAgIABIQBxTu2uRu4+zgQC3iveBAfGCAXHwgQM=",n.load()});if(!t)return"premultiply-alpha-on-upload";let s=e.createTexture();e.bindTexture(e.TEXTURE_2D,s);let i=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,i),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,s,0),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,e.NONE),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t);let o=new Uint8Array(4);return e.readPixels(0,0,1,1,e.RGBA,e.UNSIGNED_BYTE,o),e.deleteFramebuffer(i),e.deleteTexture(s),e.getExtension("WEBGL_lose_context")?.loseContext(),o[0]<=o[3]?"premultiplied-alpha":"premultiply-alpha-on-upload"})()),K}var q=class ve extends P{constructor(e){super(e),this.isReady=!1,this.uploadMethodId="video",e=b(b({},ve.defaultOptions),e),this._autoUpdate=!0,this._isConnectedToTicker=!1,this._updateFPS=e.updateFPS||0,this._msToNextUpdate=0,this.autoPlay=e.autoPlay!==!1,this.alphaMode=e.alphaMode??"premultiply-alpha-on-upload",this._videoFrameRequestCallback=this._videoFrameRequestCallback.bind(this),this._videoFrameRequestCallbackHandle=null,this._load=null,this._resolve=null,this._reject=null,this._onCanPlay=this._onCanPlay.bind(this),this._onCanPlayThrough=this._onCanPlayThrough.bind(this),this._onError=this._onError.bind(this),this._onPlayStart=this._onPlayStart.bind(this),this._onPlayStop=this._onPlayStop.bind(this),this._onSeeked=this._onSeeked.bind(this),e.autoLoad!==!1&&this.load()}updateFrame(){if(!this.destroyed){if(this._updateFPS){let e=C.shared.elapsedMS*this.resource.playbackRate;this._msToNextUpdate=Math.floor(this._msToNextUpdate-e)}(!this._updateFPS||this._msToNextUpdate<=0)&&(this._msToNextUpdate=this._updateFPS?Math.floor(1e3/this._updateFPS):0),this.isValid&&this.update()}}_videoFrameRequestCallback(){this.updateFrame(),this.destroyed?this._videoFrameRequestCallbackHandle=null:this._videoFrameRequestCallbackHandle=this.resource.requestVideoFrameCallback(this._videoFrameRequestCallback)}get isValid(){return!!this.resource.videoWidth&&!!this.resource.videoHeight}async load(){if(this._load)return this._load;let e=this.resource,t=this.options;return(e.readyState===e.HAVE_ENOUGH_DATA||e.readyState===e.HAVE_FUTURE_DATA)&&e.width&&e.height&&(e.complete=!0),e.addEventListener("play",this._onPlayStart),e.addEventListener("pause",this._onPlayStop),e.addEventListener("seeked",this._onSeeked),this._isSourceReady()?this._mediaReady():(t.preload||e.addEventListener("canplay",this._onCanPlay),e.addEventListener("canplaythrough",this._onCanPlayThrough),e.addEventListener("error",this._onError,!0)),this.alphaMode=await Pe(),this._load=new Promise((s,i)=>{this.isValid?s(this):(this._resolve=s,this._reject=i,t.preloadTimeoutMs!==void 0&&(this._preloadTimeout=setTimeout(()=>{this._onError(new ErrorEvent(`Preload exceeded timeout of ${t.preloadTimeoutMs}ms`))})),e.load())}),this._load}_onError(e){this.resource.removeEventListener("error",this._onError,!0),this.emit("error",e),this._reject&&(this._reject(e),this._reject=null,this._resolve=null)}_isSourcePlaying(){let e=this.resource;return!e.paused&&!e.ended}_isSourceReady(){return this.resource.readyState>2}_onPlayStart(){this.isValid||this._mediaReady(),this._configureAutoUpdate()}_onPlayStop(){this._configureAutoUpdate()}_onSeeked(){this._autoUpdate&&!this._isSourcePlaying()&&(this._msToNextUpdate=0,this.updateFrame(),this._msToNextUpdate=0)}_onCanPlay(){this.resource.removeEventListener("canplay",this._onCanPlay),this._mediaReady()}_onCanPlayThrough(){this.resource.removeEventListener("canplaythrough",this._onCanPlay),this._preloadTimeout&&(clearTimeout(this._preloadTimeout),this._preloadTimeout=void 0),this._mediaReady()}_mediaReady(){let e=this.resource;this.isValid&&(this.isReady=!0,this.resize(e.videoWidth,e.videoHeight)),this._msToNextUpdate=0,this.updateFrame(),this._msToNextUpdate=0,this._resolve&&(this._resolve(this),this._resolve=null,this._reject=null),this._isSourcePlaying()?this._onPlayStart():this.autoPlay&&this.resource.play()}destroy(){this._configureAutoUpdate();let e=this.resource;e&&(e.removeEventListener("play",this._onPlayStart),e.removeEventListener("pause",this._onPlayStop),e.removeEventListener("seeked",this._onSeeked),e.removeEventListener("canplay",this._onCanPlay),e.removeEventListener("canplaythrough",this._onCanPlayThrough),e.removeEventListener("error",this._onError,!0),e.pause(),e.src="",e.load()),super.destroy()}get autoUpdate(){return this._autoUpdate}set autoUpdate(e){e!==this._autoUpdate&&(this._autoUpdate=e,this._configureAutoUpdate())}get updateFPS(){return this._updateFPS}set updateFPS(e){e!==this._updateFPS&&(this._updateFPS=e,this._configureAutoUpdate())}_configureAutoUpdate(){this._autoUpdate&&this._isSourcePlaying()?!this._updateFPS&&this.resource.requestVideoFrameCallback?(this._isConnectedToTicker&&(C.shared.remove(this.updateFrame,this),this._isConnectedToTicker=!1,this._msToNextUpdate=0),this._videoFrameRequestCallbackHandle===null&&(this._videoFrameRequestCallbackHandle=this.resource.requestVideoFrameCallback(this._videoFrameRequestCallback))):(this._videoFrameRequestCallbackHandle!==null&&(this.resource.cancelVideoFrameCallback(this._videoFrameRequestCallbackHandle),this._videoFrameRequestCallbackHandle=null),this._isConnectedToTicker||(C.shared.add(this.updateFrame,this),this._isConnectedToTicker=!0,this._msToNextUpdate=0)):(this._videoFrameRequestCallbackHandle!==null&&(this.resource.cancelVideoFrameCallback(this._videoFrameRequestCallbackHandle),this._videoFrameRequestCallbackHandle=null),this._isConnectedToTicker&&(C.shared.remove(this.updateFrame,this),this._isConnectedToTicker=!1,this._msToNextUpdate=0))}static test(e){return globalThis.HTMLVideoElement&&e instanceof HTMLVideoElement}};q.extension=p.TextureSource;q.defaultOptions=G(b({},P.defaultOptions),{autoLoad:!0,autoPlay:!0,updateFPS:0,crossorigin:!0,loop:!1,muted:!0,playsinline:!0,preload:!1});q.MIME_TYPES={ogv:"video/ogg",mov:"video/quicktime",m4v:"video/mp4"};var Se=q;var J=[];E.handleByList(p.TextureSource,J);function Fe(r={}){let e=r&&r.resource,t=e?r.resource:r,s=e?r:{resource:r};for(let i=0;i<J.length;i++){let o=J[i];if(o.test(t))return new o(s)}throw new Error(`Could not find a source type for resource: ${s.resource}`)}function Le(r={},e=!1){let t=r&&r.resource,s=t?r.resource:r,i=t?r:{resource:r};if(!e&&F.has(s))return F.get(s);let o=new g({source:Fe(i)});return o.on("destroy",()=>{F.has(s)&&F.remove(s)}),e||F.set(s,o),o}function Ve(r,e=!1){return typeof r=="string"?F.get(r):r instanceof P?new g({source:r}):Le(r,e)}g.from=Ve;P.from=Fe;E.add(M,U,O,Se,ue,le,ne);var ee=class{constructor(e){this._renderer=e}push(e,t,s){this._renderer.renderPipes.batch.break(s),s.add({renderPipeId:"filter",canBundle:!1,action:"pushFilter",container:t,filterEffect:e})}pop(e,t,s){this._renderer.renderPipes.batch.break(s),s.add({renderPipeId:"filter",action:"popFilter",canBundle:!1})}execute(e){e.action==="pushFilter"?this._renderer.filter.push(e):e.action==="popFilter"&&this._renderer.filter.pop()}destroy(){this._renderer=null}};ee.extension={type:[p.WebGLPipes,p.WebGPUPipes,p.CanvasPipes],name:"filter"};var ke=`in vec2 aPosition;
out vec2 vTextureCoord;

uniform vec4 uInputSize;
uniform vec4 uOutputFrame;
uniform vec4 uOutputTexture;

vec4 filterVertexPosition( void )
{
    vec2 position = aPosition * uOutputFrame.zw + uOutputFrame.xy;
    
    position.x = position.x * (2.0 / uOutputTexture.x) - 1.0;
    position.y = position.y * (2.0*uOutputTexture.z / uOutputTexture.y) - uOutputTexture.z;

    return vec4(position, 0.0, 1.0);
}

vec2 filterTextureCoord( void )
{
    return aPosition * (uOutputFrame.zw * uInputSize.zw);
}

void main(void)
{
    gl_Position = filterVertexPosition();
    vTextureCoord = filterTextureCoord();
}
`;var Ee=`in vec2 vTextureCoord;
out vec4 finalColor;
uniform sampler2D uTexture;
void main() {
    finalColor = texture(uTexture, vTextureCoord);
}
`;var te=`struct GlobalFilterUniforms {
  uInputSize: vec4<f32>,
  uInputPixel: vec4<f32>,
  uInputClamp: vec4<f32>,
  uOutputFrame: vec4<f32>,
  uGlobalFrame: vec4<f32>,
  uOutputTexture: vec4<f32>,
};

@group(0) @binding(0) var <uniform> gfu: GlobalFilterUniforms;
@group(0) @binding(1) var uTexture: texture_2d<f32>;
@group(0) @binding(2) var uSampler: sampler;

struct VSOutput {
  @builtin(position) position: vec4<f32>,
  @location(0) uv: vec2<f32>
};

fn filterVertexPosition(aPosition: vec2<f32>) -> vec4<f32>
{
    var position = aPosition * gfu.uOutputFrame.zw + gfu.uOutputFrame.xy;

    position.x = position.x * (2.0 / gfu.uOutputTexture.x) - 1.0;
    position.y = position.y * (2.0 * gfu.uOutputTexture.z / gfu.uOutputTexture.y) - gfu.uOutputTexture.z;

    return vec4(position, 0.0, 1.0);
}

fn filterTextureCoord(aPosition: vec2<f32>) -> vec2<f32>
{
    return aPosition * (gfu.uOutputFrame.zw * gfu.uInputSize.zw);
}

@vertex
fn mainVertex(
  @location(0) aPosition: vec2<f32>,
) -> VSOutput {
  return VSOutput(
   filterVertexPosition(aPosition),
   filterTextureCoord(aPosition)
  );
}

@fragment
fn mainFragment(
  @location(0) uv: vec2<f32>,
) -> @location(0) vec4<f32> {
    return textureSample(uTexture, uSampler, uv);
}
`;var j=class extends pe{constructor(){let e=he.from({vertex:{source:te,entryPoint:"mainVertex"},fragment:{source:te,entryPoint:"mainFragment"},name:"passthrough-filter"}),t=ce.from({vertex:ke,fragment:Ee,name:"passthrough-filter"});super({gpuProgram:e,glProgram:t})}};var Be=new L;function Re(r,e){e.clear();let t=e.matrix;for(let s=0;s<r.length;s++){let i=r[s];if(i.globalDisplayStatus<7)continue;let o=i.renderGroup??i.parentRenderGroup;o?.isCachedAsTexture?e.matrix=Be.copyFrom(o.textureOffsetInverseTransform).append(i.worldTransform):o?._parentCacheAsTextureRenderGroup?e.matrix=Be.copyFrom(o._parentCacheAsTextureRenderGroup.inverseWorldTransform).append(i.groupTransform):e.matrix=i.worldTransform,e.addBounds(i.bounds)}return e.matrix=t,e}var He=new _e({attributes:{aPosition:{buffer:new Float32Array([0,0,1,0,1,1,0,1]),format:"float32x2",stride:8,offset:0}},indexBuffer:new Uint32Array([0,1,2,0,2,3])}),re=class{constructor(){this.skip=!1,this.inputTexture=null,this.backTexture=null,this.filters=null,this.bounds=new V,this.container=null,this.blendRequired=!1,this.outputRenderSurface=null,this.globalFrame={x:0,y:0,width:0,height:0},this.firstEnabledIndex=-1,this.lastEnabledIndex=-1}},se=class{constructor(e){this._filterStackIndex=0,this._filterStack=[],this._filterGlobalUniforms=new me({uInputSize:{value:new Float32Array(4),type:"vec4<f32>"},uInputPixel:{value:new Float32Array(4),type:"vec4<f32>"},uInputClamp:{value:new Float32Array(4),type:"vec4<f32>"},uOutputFrame:{value:new Float32Array(4),type:"vec4<f32>"},uGlobalFrame:{value:new Float32Array(4),type:"vec4<f32>"},uOutputTexture:{value:new Float32Array(4),type:"vec4<f32>"}}),this._globalFilterBindGroup=new de({}),this.renderer=e}get activeBackTexture(){return this._activeFilterData?.backTexture}push(e){let t=this.renderer,s=e.filterEffect.filters,i=this._pushFilterData();i.skip=!1,i.filters=s,i.container=e.container,i.outputRenderSurface=t.renderTarget.renderSurface;let o=t.renderTarget.renderTarget.colorTexture.source,a=o.resolution,n=o.antialias;if(s.every(f=>!f.enabled)){i.skip=!0;return}let l=i.bounds;if(this._calculateFilterArea(e,l),this._calculateFilterBounds(i,t.renderTarget.rootViewPort,n,a,1),i.skip)return;let u=this._getPreviousFilterData(),h=this._findFilterResolution(a),c=0,d=0;u&&(c=u.bounds.minX,d=u.bounds.minY),this._calculateGlobalFrame(i,c,d,h,o.width,o.height),this._setupFilterTextures(i,l,t,u)}generateFilteredTexture({texture:e,filters:t}){let s=this._pushFilterData();this._activeFilterData=s,s.skip=!1,s.filters=t;let i=e.source,o=i.resolution,a=i.antialias;if(t.every(f=>!f.enabled))return s.skip=!0,e;let n=s.bounds;if(n.addRect(e.frame),this._calculateFilterBounds(s,n.rectangle,a,o,0),s.skip)return e;let l=o;this._calculateGlobalFrame(s,0,0,l,i.width,i.height),s.outputRenderSurface=v.getOptimalTexture(n.width,n.height,s.resolution,s.antialias),s.backTexture=g.EMPTY,s.inputTexture=e,this.renderer.renderTarget.finishRenderPass(),this._applyFiltersToTexture(s,!0);let d=s.outputRenderSurface;return d.source.alphaMode="premultiplied-alpha",d}pop(){let e=this.renderer,t=this._popFilterData();t.skip||(e.globalUniforms.pop(),e.renderTarget.finishRenderPass(),this._activeFilterData=t,this._applyFiltersToTexture(t,!1),t.blendRequired&&v.returnTexture(t.backTexture),v.returnTexture(t.inputTexture))}getBackTexture(e,t,s){let i=e.colorTexture.source._resolution,o=v.getOptimalTexture(t.width,t.height,i,!1),a=t.minX,n=t.minY;s&&(a-=s.minX,n-=s.minY),a=Math.floor(a*i),n=Math.floor(n*i);let l=Math.ceil(t.width*i),u=Math.ceil(t.height*i);return this.renderer.renderTarget.copyToTexture(e,o,{x:a,y:n},{width:l,height:u},{x:0,y:0}),o}applyFilter(e,t,s,i){let o=this.renderer,a=this._activeFilterData,l=a.outputRenderSurface===s,u=o.renderTarget.rootRenderTarget.colorTexture.source._resolution,h=this._findFilterResolution(u),c=0,d=0;if(l){let _=this._findPreviousFilterOffset();c=_.x,d=_.y}this._updateFilterUniforms(t,s,a,c,d,h,l,i);let f=e.enabled?e:this._getPassthroughFilter();this._setupBindGroupsAndRender(f,t,o)}calculateSpriteMatrix(e,t){let s=this._activeFilterData,i=e.set(s.inputTexture._source.width,0,0,s.inputTexture._source.height,s.bounds.minX,s.bounds.minY),o=t.worldTransform.copyTo(L.shared),a=t.renderGroup||t.parentRenderGroup;return a&&a.cacheToLocalTransform&&o.prepend(a.cacheToLocalTransform),o.invert(),i.prepend(o),i.scale(1/t.texture.orig.width,1/t.texture.orig.height),i.translate(t.anchor.x,t.anchor.y),i}destroy(){this._passthroughFilter?.destroy(!0),this._passthroughFilter=null}_getPassthroughFilter(){return this._passthroughFilter??(this._passthroughFilter=new j),this._passthroughFilter}_setupBindGroupsAndRender(e,t,s){if(s.renderPipes.uniformBatch){let i=s.renderPipes.uniformBatch.getUboResource(this._filterGlobalUniforms);this._globalFilterBindGroup.setResource(i,0)}else this._globalFilterBindGroup.setResource(this._filterGlobalUniforms,0);this._globalFilterBindGroup.setResource(t.source,1),this._globalFilterBindGroup.setResource(t.source.style,2),e.groups[0]=this._globalFilterBindGroup,s.encoder.draw({geometry:He,shader:e,state:e._state,topology:"triangle-list"}),s.type===fe.WEBGL&&s.renderTarget.finishRenderPass()}_setupFilterTextures(e,t,s,i){if(e.backTexture=g.EMPTY,e.inputTexture=v.getOptimalTexture(t.width,t.height,e.resolution,e.antialias),e.blendRequired){s.renderTarget.finishRenderPass();let o=s.renderTarget.getRenderTarget(e.outputRenderSurface);e.backTexture=this.getBackTexture(o,t,i?.bounds)}s.renderTarget.bind(e.inputTexture,!0),s.globalUniforms.push({offset:t})}_calculateGlobalFrame(e,t,s,i,o,a){let n=e.globalFrame;n.x=t*i,n.y=s*i,n.width=o*i,n.height=a*i}_updateFilterUniforms(e,t,s,i,o,a,n,l){let u=this._filterGlobalUniforms.uniforms,h=u.uOutputFrame,c=u.uInputSize,d=u.uInputPixel,f=u.uInputClamp,_=u.uGlobalFrame,T=u.uOutputTexture;n?(h[0]=s.bounds.minX-i,h[1]=s.bounds.minY-o):(h[0]=0,h[1]=0),h[2]=e.frame.width,h[3]=e.frame.height,c[0]=e.source.width,c[1]=e.source.height,c[2]=1/c[0],c[3]=1/c[1],d[0]=e.source.pixelWidth,d[1]=e.source.pixelHeight,d[2]=1/d[0],d[3]=1/d[1],f[0]=.5*d[2],f[1]=.5*d[3],f[2]=e.frame.width*c[2]-.5*d[2],f[3]=e.frame.height*c[3]-.5*d[3];let A=this.renderer.renderTarget.rootRenderTarget.colorTexture;_[0]=i*a,_[1]=o*a,_[2]=A.source.width*a,_[3]=A.source.height*a,t instanceof g&&(t.source.resource=null);let m=this.renderer.renderTarget.getRenderTarget(t);this.renderer.renderTarget.bind(t,!!l),t instanceof g?(T[0]=t.frame.width,T[1]=t.frame.height):(T[0]=m.width,T[1]=m.height),T[2]=m.isRoot?-1:1,this._filterGlobalUniforms.update()}_findFilterResolution(e){let t=this._filterStackIndex-1;for(;t>0&&this._filterStack[t].skip;)--t;return t>0&&this._filterStack[t].inputTexture?this._filterStack[t].inputTexture.source._resolution:e}_findPreviousFilterOffset(){let e=0,t=0,s=this._filterStackIndex;for(;s>0;){s--;let i=this._filterStack[s];if(!i.skip){e=i.bounds.minX,t=i.bounds.minY;break}}return{x:e,y:t}}_calculateFilterArea(e,t){if(e.renderables?Re(e.renderables,t):e.filterEffect.filterArea?(t.clear(),t.addRect(e.filterEffect.filterArea),t.applyMatrix(e.container.worldTransform)):e.container.getFastGlobalBounds(!0,t),e.container){let i=(e.container.renderGroup||e.container.parentRenderGroup).cacheToLocalTransform;i&&t.applyMatrix(i)}}_applyFiltersToTexture(e,t){let s=e.inputTexture,i=e.bounds,o=e.filters,a=e.firstEnabledIndex,n=e.lastEnabledIndex;if(this._globalFilterBindGroup.setResource(s.source.style,2),this._globalFilterBindGroup.setResource(e.backTexture.source,3),a===n)o[a].apply(this,s,e.outputRenderSurface,t);else{let l=e.inputTexture,u=v.getOptimalTexture(i.width,i.height,l.source._resolution,!1),h=u;for(let c=a;c<n;c++){let d=o[c];if(!d.enabled)continue;d.apply(this,l,h,!0);let f=l;l=h,h=f}o[n].apply(this,l,e.outputRenderSurface,t),v.returnTexture(u)}}_calculateFilterBounds(e,t,s,i,o){let a=this.renderer,n=e.bounds,l=e.filters,u=1/0,h=0,c=!0,d=!1,f=!1,_=!0,T=-1,A=-1;for(let m=0;m<l.length;m++){let x=l[m];if(!x.enabled)continue;if(T===-1&&(T=m),A=m,u=Math.min(u,x.resolution==="inherit"?i:x.resolution),h+=x.padding,x.antialias==="off"?c=!1:x.antialias==="inherit"&&c&&(c=s),x.clipToViewport||(_=!1),!!!(x.compatibleRenderers&a.type)){f=!1;break}if(x.blendRequired&&!(a.backBuffer?.useBackBuffer??!0)){S("Blend filter requires backBuffer on WebGL renderer to be enabled. Set `useBackBuffer: true` in the renderer options."),f=!1;break}f=!0,d||(d=x.blendRequired)}if(!f){e.skip=!0;return}if(_&&n.fitBounds(0,t.width/i,0,t.height/i),n.scale(u).ceil().scale(1/u).pad((h|0)*o),!n.isPositive){e.skip=!0;return}e.antialias=c,e.resolution=u,e.blendRequired=d,e.firstEnabledIndex=T,e.lastEnabledIndex=A}_popFilterData(){return this._filterStackIndex--,this._filterStack[this._filterStackIndex]}_getPreviousFilterData(){let e,t=this._filterStackIndex-1;for(;t>0&&(t--,e=this._filterStack[t],!!e.skip););return e}_pushFilterData(){let e=this._filterStack[this._filterStackIndex];return e||(e=this._filterStack[this._filterStackIndex]=new re),this._filterStackIndex++,e}};se.extension={type:[p.WebGLSystem,p.WebGPUSystem],name:"filter"};export{Y as a,k as b,X as c,ge as d,Q as e,Pe as f,Se as g,ee as h,se as i};
